<?xml version="1.0" encoding="UTF-8"?>
<!--
    This build file contains common targets for handling pear and pear package
    related tasks.

    General markup guidelines:
      - Targets starting with "-" are protected and should never be called
        directly.
      - Targets starting with "~" are hooks that can be overwritten to custom
        functionality.

      - Properties names containing "-" are parameters and they should be
        supplied by using ant's <param /> tag.
      - Properties names containing "." are global properties that are defined
        in a *.properties file or in a build file.
-->
<project name="common-pear-ant-targets" basedir=".">
    
    <!--
        Declare basedir for commons pear
    -->
    <dirname property="common-pear-ant-targets.basedir" file="${ant.file.common-pear-ant-targets}" />

    <!--
        Import default settings
    -->
    <property file="${common-pear-ant-targets.basedir}/pear.properties" />

    <!--
        Discovers a pear channel specified as parameter.

        Parameters
          ${package.pear.channel.uri}
    -->
    <target name="common-pear-channel-discover" depends="-common-pear-prepare">
        <!-- First try to delete a previous discovered channel -->
        <exec executable="pear">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="channel-delete" />
            <arg line="${package.pear.channel.uri}" />
        </exec>

        <exec executable="pear" failonerror="true">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="channel-discover" />
            <arg line="${package.pear.channel.uri}" />
        </exec>
    </target>

    <!--
        Installs a remote pear package.

        Parameters
          ${pear-package}
    -->
    <target name="common-pear-install-remote" depends="-common-pear-prepare">
        <exec executable="pear" failonerror="true">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="install" />
            <arg line="--alldeps" />
            <arg line="--nobuild" />
            <arg line="${pear-package}" />
        </exec>
    </target>

    <!--
        Installs a local pear package.

        Parameters
          ${pear-package-pattern}
    -->
    <target name="common-pear-install-local" depends="-common-pear-prepare">
        <apply executable="pear" failonerror="true">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="install" />
            <arg line="--alldeps" />
            <arg line="--nobuild" />
            <fileset dir="${distdir}">
                <include name="*-${build.version}.tgz" />
            </fileset>
        </apply>
    </target>

    <!--
        Creates a temporary pear environment and defines a few properties
        required by most pear related targets:

        Properties:
          ${common-pear-base-dir}  The pear root directory.
          ${common-pear-bin-dir}   The pear binary directory.
          ${common-pear-root-dir}  The pear library install directory.
          ${common-pear-config}    The pear configuration file.
    -->
    <target name="-common-pear-prepare"
            depends="-common-pear-prepare-properties,
                     -common-pear-prepare-test-exists,
                     -common-pear-prepare-if-not-exists" />

    <!--
        Defines a few properties required by most pear related targets:

        Properties:
          ${common-pear-base-dir}  The pear root directory.
          ${common-pear-bin-dir}   The pear binary directory.
          ${common-pear-root-dir}  The pear library install directory.
          ${common-pear-config}    The pear configuration file.
    -->
    <target name="-common-pear-prepare-properties">
        <property name="common-pear-base-dir" value="${builddir}/pear" />
        <property name="common-pear-bin-dir" value="${common-pear-base-dir}/pear" />
        <property name="common-pear-root-dir" value="${common-pear-bin-dir}/php" />
        <property name="common-pear-config" value="${common-pear-base-dir}/.pearrc" />
    </target>

    <!--
        Checks if the temporary pear environment already exists. If it exists
        this target will set the ${common-pear-prepare-exists} property.
    -->
    <target name="-common-pear-prepare-test-exists">
        <available file="${common-pear-config}" property="common-pear-prepare-exists" />
    </target>

    <!--
        Creates a temporary pear environment and defines two properties required
        by most pear related targets:
    -->
    <target name="-common-pear-prepare-if-not-exists" unless="common-pear-prepare-exists">

        <mkdir dir="${common-pear-base-dir}" />

        <exec executable="pear" failonerror="true" output="/dev/null">
            <arg line="config-create" />
            <arg line="${common-pear-base-dir}" />
            <arg line="${common-pear-config}" />
        </exec>

        <exec executable="pear" failonerror="true">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="config-set" />
            <arg line="preferred_state" />
            <arg line="alpha" />
        </exec>

        <exec executable="pear" failonerror="true">
            <arg line="-c" />
            <arg line="${common-pear-config}" />
            <arg line="config-set" />
            <arg line="auto_discover" />
            <arg line="1" />
        </exec>
    </target>

</project>
