<?xml version="1.0" encoding="UTF-8"?>
<project name="ant-build-commons-extensions-requirejs-bootstrap" basedir=".">
    <!--
         External entrypoint to this module
    -->
    <target name="requirejs:bootstrap">
        <!--
            @TODO: Once the availibility extension is merged it should be used
            here to check wheather a javascript srcdir exists before running
            this one
        -->
        <antcall target="-requirejs:bootstrap" />
    </target>

    <!--
         Internal entrypoint to the module
    -->
    <target name="-requirejs:bootstrap"
            depends="-requirejs:bootstrap:before~hook,
                     -requirejs:bootstrap:run,
                     -requirejs:bootstrap:after~hook" />

    <!--
         Build the needed bootstrapping file

         The file contains the requirejs library, all defined loaders as well
         as an initial request to the application entrypoint file
    -->
    <target name="-requirejs:bootstrap:run"
            depends="-requirejs:create-bootstrap-path,
                     -requirejs:bootstrap:combine-requirejs-and-loaders,
                     -requirejs:bootstrap:create-runtime-configuration">
        <concat destfile="${-requirejs:out-bootstrap-path}">
            <file file="${-requirejs:bootstrap:out-combined-requirejs-and-loaders}" />
            <string value="${-requirejs:bootstrap:out-runtime-configuration}" />
            <string value="require(['/${requirejs.entrypoint}']);" />
        </concat>
    </target>

    <!--
        Create the needed runtime configuration for requirejs to load our
        javascript files properly. This configuration does mainly consist of
        the baseUrl, which is extracted from the given entrypoint.
    -->
    <target name="-requirejs:bootstrap:create-runtime-configuration">
        <script language="javascript" setbeans="false"><![CDATA[
            var entrypointDirectory = new java.io.File(
                project.getProperty('requirejs.entrypoint')
            ).getParent();

            var baseUrl = "/";
            if (entrypointDirectory !== null) {
                baseUrl = "/" + entrypointDirectory;
            }

            project.setProperty(
                '-requirejs:bootstrap:out-runtime-configuration',
                'require.config({baseUrl: "' + baseUrl + '"});'
            );
        ]]></script>
    </target>

    <!--
         Build a combined version of the requirejs library as well as all
         defined loaders.

         Dependencies will be resolved and remapped to proper naming,
         eventhough the loaders may reside at an arbitrary position
    -->
    <target name="-requirejs:bootstrap:combine-requirejs-and-loaders"
            depends="-requirejs:bootstrap:create-build-js">
        <exec executable="${commons.executable.rhino}"
              failonerror="true">
            <arg value="${resourcedir}/extensions/requirejs/r.js" />
            <arg value="-o" />
            <arg value="${-requirejs:bootstrap:out-build-js}" />
        </exec>
    </target>

    <!--
         Generate the ´include´ and ´paths´ contents for the build
         configuration file, which is sent to r.js for correct resolvement of
         loader and requirejs dependencies

         The output is in JSON format

        @param -requirejs:bootstrap:out-build-config-paths
        @param -requirejs:bootstrap:out-build-config-include
    -->
    <target name="-requirejs:bootstrap:create-build-config-paths-and-include">
        <script language="javascript" setbeans="false"><![CDATA[
            var paths = {};
            var includeString = "";
            var pathsString = "";
            var i = null;

            paths.requireJS = project.getProperty("resourcedir") + '/extensions/requirejs/require';

            var enumeration = project.getProperties().keys();
            var propertyNameRegExp = /^(requirejs\.loader\.)([a-zA-Z0-9]+)$/;
            var propertyValueRegExp = /^(.+?)(\.js)?$/;
            while(enumeration.hasMoreElements()) {
                (function(property) {
                    var nameMatches = propertyNameRegExp.exec(property);
                    if (nameMatches === null) {
                        return;
                    }

                    var propertyValue = project.getProperty(property);
                    var valueMatches = propertyValueRegExp.exec(propertyValue);

                    paths[nameMatches[2]] = valueMatches[1];
                })(enumeration.nextElement());
            }

            includeString = "[";
            pathsString = "{";
            for( i in paths ) {
                (function(name, path) {
                    var encodedName = '"' + name + '"';
                    var encodedPath = '"' + path + '"';
                    includeString += encodedName + ",";
                    pathsString += encodedName + ':' + encodedPath + ",";
                })(i, paths[i]);
            }
            includeString = includeString.substring(0, includeString.length - 1);
            includeString += "]";
            pathsString = pathsString.substring(0, pathsString.length - 1);
            pathsString += "}";

            project.setProperty('-requirejs:bootstrap:out-build-config-paths', pathsString);
            project.setProperty('-requirejs:bootstrap:out-build-config-include', includeString);
        ]]></script>
    </target>

    <!--
         Create the necessary build file, which is used by r.js to create the
         needed bootstrapping file with all dependencies handled properly

         The path of the buildfile as well as the path of the file which will
         be generated, if the buildfile is executed is returned.

         @param -requirejs:bootstrap:out-build-js
         @param -requirejs:bootstrap:out-combined-requirejs-and-loaders
    -->
    <target name="-requirejs:bootstrap:create-build-js"
            depends="-requirejs:bootstrap:create-build-config-paths-and-include">
        <tempfile destdir="${commons:tmpdir}" property="-requirejs:bootstrap:out-build-js" prefix="requirejs" deleteonexit="false" />
        <tempfile destdir="${commons:tmpdir}" property="-requirejs:bootstrap:out-combined-requirejs-and-loaders" prefix="requirejs" deleteonexit="false" />
        <copy file="${resourcedir}/extensions/requirejs/build.config/bootstrap.build.js"
               tofile="${-requirejs:bootstrap:out-build-js}" />
        <replace file="${-requirejs:bootstrap:out-build-js}">
            <replacefilter token="%build.paths%" value="${-requirejs:bootstrap:out-build-config-paths}" />
            <replacefilter token="%build.include%" value="${-requirejs:bootstrap:out-build-config-include}" />
            <replacefilter token="%build.out%" value="${-requirejs:bootstrap:out-combined-requirejs-and-loaders}" />
        </replace>
    </target>

    <!--
         Extension points of the requirejs:bootstrap module
    -->
    <extension-point name="-requirejs:bootstrap:before~hook" />
    <extension-point name="-requirejs:bootstrap:after~hook" />

    <!--
         Hook this module into the build-process, by executing it after the
         compile step
    -->
    <target name="-requirejs:bootstrap:compile:after~hooked"
            depends="requirejs:bootstrap"
            extensionOf="-compile:after~hook" />

</project>
