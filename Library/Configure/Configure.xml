<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "../../Experiments/ant.dtd">

<project name="ABC:Configure">

    <property name="abc.configure.base.directory"
              location="${abc.base.directory}/Configure" />

    <property name="abc:resources.directory"
              location="${abc.configure.base.directory}/../../Resources" />

    <property file="${abc.configure.base.directory}/Configure.properties" />

    <target name="-abc:configure:configure">
        <property name="abc:configure:resources.directory"
                  value="${abc:resources.directory}/Configure" />

        <tempfile property="abc:configure:extensions.file"
                  deleteonexit="true" />

        <tempfile property="abc:configure:profiles.file"
                  deleteonexit="true" />

        <echoproperties destfile="${abc:configure:profiles.file}"
                        prefix="profile."
                        format="xml" />

        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="false">
            <file file="${abc:configure:resources.directory}/header.xml" />
        </concat>
        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="true"
                fixlastline="true">
            <file file="${abc:configure:profiles.file}" />
            <fileset dir="${abc:custom.extensions.directory}"
                     includes="**/Extension.xml"
                     erroronmissingdir="false" />

            <fileset dir="${abc.extensions.directory}"
                     includes="**/Extension.xml" />

            <filterchain>
                <tokenfilter>
                    <filetokenizer />
                    <replaceregex pattern="&lt;\?xml\s[^?]+\?&gt;"
                                  replace=""
                                  flags="g" />
                </tokenfilter>
            </filterchain>
        </concat>
        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="true">
            <file file="${abc:configure:resources.directory}/footer.xml" />
        </concat>

        <property name="ant.basedir" location="${basedir}" />
        <property name="ant.project.build-file" location="${ant.file}" />

        <condition property="abc.project.default-target"
                   value="${ant.project.default-target}"
                   else="verify">
            <isset property="ant.project.default-target" />
        </condition>

        <xslt in="${abc:configure:extensions.file}"
              out="${user.dir}/build.xml"
              style="${abc.configure.base.directory}/Configure.xslt">
            <param name="abc.project.default-target" expression="${abc.project.default-target}" />
            <param name="ant.project.name" expression="${ant.project.name}" />
            <param name="ant.basedir" expression="${ant.basedir}" />
            <param name="ant.project.build-file" expression="${ant.project.build-file}" />
            <param name="user.dir" expression="${user.dir}" />

            <param name="abc.extensions.directory" expression="${abc.extensions.directory}" />
            <param name="project.extensions.directory" expression="${abc:custom.extensions.directory}" />
        </xslt>
    </target>

    <target name="configure" depends="-abc:configure:configure" />
</project>
