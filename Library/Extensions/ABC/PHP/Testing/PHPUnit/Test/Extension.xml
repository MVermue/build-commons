<?xml version="1.0" encoding="UTF-8" ?>
<project name="ABC:PHP:Testing:PHPUnit:Test:Extension"
         xmlns:ac="http://ant-contrib.sourceforge.net"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <abc:extension-init name="ABC:PHP:Testing:PHPUnit:Test:Extension" />

    <target name="-ABC:PHP:Testing:PHPUnit:Test:Extension"
            depends="-ABC:Environment:PHP:PHPUnit:Extension"
            extensionOf="-test:main~hook">

        <!-- Support for changes based phpunit test runs.
             To enable this a corresponding compositemapper needs to be defined
             for each project, which maps src file paths to test file and/or
             directory paths -->
        <ac:if>
            <isreference refid="abc.php.testing.phpunit.test.changes.mapper"
                         type="compositemapper" />
            <ac:then>
                <abc:changed-fileset id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset"
                                     dir="${abc.source.php.directory}">
                    <include name="**/*.php" />
                </abc:changed-fileset>
                <abc:changed-fileset id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset"
                                     dir="${abc.test.php.directory}">
                    <include name="**/*.php" />
                </abc:changed-fileset>

                <pathconvert property="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset.Converted"
                             refid="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset">
                    <mapper refid="abc.php.testing.phpunit.test.changes.mapper" />
                </pathconvert>

                <path id="-ABC.PHP.Testing.PHPUnit.Test.Path.Selection">
                    <pathelement path="${-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset.Converted}" />
                    <fileset refid="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset" />
                </path>
            </ac:then>
            <ac:else>
                <path id="-ABC.PHP.Testing.PHPUnit.Test.Path.Selection">
                    <pathelement location="${abc.test.php.directory}" />
                </path>
            </ac:else>
        </ac:if>

        <!-- Run PHPUnit with the proper configuration and fileset -->

        <!-- TODO: This does not work yet with a full set of test.php files to execute
             Unfortunately there does not seem to be a way to provide PHPUnit with a bunch of files
             to execute. It is possible to supply it with ONE file or ONE directory to treat as a suite,
             but not with a list of files :(.
             If anyone knows a way how to do this on the commandline I would appreciate a hint.
             Another solution would be to generate a custom suite here and run it, but this does not seem
             practical :(.-->
        <abc:environment-phpunit configuration="${abc.php.testing.phpunit.test.configuration.file}"
                                 dir="${abc.php.testing.phpunit.test.run.directory}">
            <paths>
                <path refid="-ABC.PHP.Testing.PHPUnit.Test.Path.Selection" />
            </paths>
        </abc:environment-phpunit>

        <!-- If changes based execution is enabled we need to commit the change
             sets after a successful phpunit run -->
        <ac:if>
            <isreference refid="abc.php.testing.phpunit.test.changes.mapper"
                         type="compositemapper" />
            <ac:then>
                <abc:commit-changes id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset" />
                <abc:commit-changes id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset" />
            </ac:then>
        </ac:if>
    </target>

    <target name="abc:php:testing:phpunit:test"
            depends="-ABC:PHP:Testing:PHPUnit:Test:Extension" />
</project>
