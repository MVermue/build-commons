<?xml version="1.0" encoding="UTF-8" ?>
<project name="ABC:PHP:Testing:PHPUnit:Test:Extension"
         xmlns:ac="http://ant-contrib.sourceforge.net"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <abc:extension-init name="ABC:PHP:Testing:PHPUnit:Test:Extension" />

    <target name="-ABC:PHP:Testing:PHPUnit:Test:Extension"
            depends="-ABC:Environment:PHP:PHPUnit:Extension"
            extensionOf="-test:main~hook">

        <!-- Support for changes based phpunit test runs.
             To enable this corresponding compositemappers need to be defined
             for each project, which map src file paths to test file and/or
             directory paths, as well as test file names to Test class names -->
        <internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>
            <then>
                <!-- Pull in changed files -->
                <abc:changed-fileset id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset"
                                     dir="${abc.source.php.directory}">
                    <include name="**/*.php" />
                </abc:changed-fileset>
                <abc:changed-fileset id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset"
                                     dir="${abc.test.php.directory}">
                    <include name="**/*.php" />
                </abc:changed-fileset>

                <pathconvert property="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Based.Tests"
                             refid="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset"
                             pathsep="|">
                    <chainedmapper>
                        <mapper refid="abc.php.testing.phpunit.test.source-to-test-file.mapper" />
                        <mapper refid="abc.php.testing.phpunit.test.test-file-to-test.mapper" />
                        <filtermapper>
                            <replacestring from="\"
                                           to="\\" />
                        </filtermapper>
                    </chainedmapper>
                </pathconvert>

                <pathconvert property="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Based.Tests"
                             refid="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset"
                             pathsep="|">
                    <chainedmapper>
                        <mapper refid="abc.php.testing.phpunit.test.test-file-to-test.mapper" />
                        <filtermapper>
                            <replacestring from="\"
                                           to="\\" />
                        </filtermapper>
                    </chainedmapper>
                </pathconvert>
            </then>
        </internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>

        <!-- Run PHPUnit with the proper configuration and fileset -->
        <internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>
            <then>
                <abc:environment-phpunit configuration="${abc.php.testing.phpunit.test.configuration.file}"
                                         dir="${abc.php.testing.phpunit.test.run.directory}">
                    <arguments>
                        <arg line="--filter '(^(${-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Based.Tests}|${-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Based.Tests})::)'" />
                    </arguments>
                </abc:environment-phpunit>
            </then>
            <else>
                <abc:environment-phpunit configuration="${abc.php.testing.phpunit.test.configuration.file}"
                                         dir="${abc.php.testing.phpunit.test.run.directory}" />
            </else>
        </internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>

        <!-- If changes based execution is enabled we need to commit the change
             sets after a successful phpunit run -->
        <internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>
            <then>
                <abc:commit-changes id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Source.Fileset" />
                <abc:commit-changes id="-ABC.PHP.Testing.PHPUnit.Test.Changes.Test.Fileset" />
            </then>
        </internal:ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled>
    </target>

    <!-- Condition to check of changes handling is enabled -->
    <internal:macrodef name="ABC.PHP.Testing.PHPUnit.Test.If.Changes.Enabled">
        <element name="then" />
        <element name="else" optional="true" />

        <sequential>
            <ac:if>
                <and>
                    <isreference refid="abc.php.testing.phpunit.test.source-to-test-file.mapper"
                                 type="chainedmapper" />
                    <isreference refid="abc.php.testing.phpunit.test.test-file-to-test.mapper"
                                 type="chainedmapper" />
                </and>
                <ac:then>
                    <then />
                </ac:then>
                <ac:else>
                    <else />
                </ac:else>
            </ac:if>
        </sequential>
    </internal:macrodef>

    <target name="abc:php:testing:phpunit:test"
            depends="-ABC:PHP:Testing:PHPUnit:Test:Extension" />
</project>
