<?xml version="1.0" encoding="UTF-8" ?>
<!--<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "../../../../../Experiments/ant.dtd">-->
<project name="ABC:Core:Configure"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <target name="-ABC:Core:Configure:Extension">
        <abc:extension-init extension="ABC:Core:Configure"
                            has-resources="true" />

        <tempfile property="-ABC.Core.Configure.Generated.File"
                  deleteonexit="true" />

        <tempfile property="-ABC.Core.Configure.Enabled-Profiles.File"
                  deleteonexit="true" />

        <echoproperties destfile="${-ABC.Core.Configure.Enabled-Profiles.File}"
                        prefix="profile."
                        format="xml" />

        <concat destfile="${-ABC.Core.Configure.Generated.File}"
                overwrite="true"
                append="false">
            <file file="${abc.core.configure.resources.directory}/Header.xml" />
        </concat>
        <concat destfile="${-ABC.Core.Configure.Generated.File}"
                overwrite="true"
                append="true"
                fixlastline="true">
            <file file="${-ABC.Core.Configure.Enabled-Profiles.File}" />
            <file file="${abc.core.configure.resources.directory}/Profile-Defaults.xml" />
            <fileset dir="${project.extensions.directory}"
                     includes="**/Extension.xml"
                     erroronmissingdir="false" />

            <fileset dir="${abc.extensions.directory}"
                     includes="**/Extension.xml" />

            <filterchain>
                <tokenfilter>
                    <filetokenizer />
                    <replaceregex pattern="&lt;\?xml\s[^?]+\?&gt;"
                                  replace=""
                                  flags="g" />
                </tokenfilter>
            </filterchain>
        </concat>
        <concat destfile="${-ABC.Core.Configure.Generated.File}"
                overwrite="true"
                append="true">
            <file file="${abc.core.configure.resources.directory}/Footer.xml" />
        </concat>

        <property name="-ABC.Core.Configure.Base.Directory" location="${basedir}" />
        <property name="-ABC.Core.Configure.Build.File" location="${ant.file}" />

        <condition property="-ABC.Core.Configure.Default-Target"
                   value="${ant.project.default-target}"
                   else="verify">
            <isset property="ant.project.default-target" />
        </condition>

        <xslt taskname="ABC:Core:Configure:Extension"
              in="${-ABC.Core.Configure.Generated.File}"
              out="${user.dir}/build.xml"
              style="${abc.core.configure.resources.directory}/Configure.xslt">

            <param name="project.default-target" expression="${-ABC.Core.Configure.Default-Target}" />
            <param name="ant.project.name" expression="${ant.project.name}" />
            <param name="ant.basedir" expression="${-ABC.Core.Configure.Base.Directory}" />
            <param name="ant.project.build-file" expression="${-ABC.Core.Configure.Build.File}" />
            <param name="user.dir" expression="${user.dir}" />

            <param name="abc.extensions.directory" expression="${abc.extensions.directory}" />
            <param name="project.extensions.directory" expression="${project.extensions.directory}" />
        </xslt>
    </target>

    <target name="configure" depends="-ABC:Core:Configure:Extension" />
</project>
