<?xml version="1.0" encoding="UTF-8" ?>
<!--<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "../../../../../Experiments/ant.dtd">-->
<project name="ABC:Core:Configure">

    <property name="abc.configure.base.directory"
              location="${abc.base.directory}/Configure" />

    <property file="${abc.configure.base.directory}/Extension.properties" />

    <target name="-ABC:Core:Configure:Extension">

        <!--<abc-extension-properties extension="ABC:Core:Configure" />-->

        <abc-extension-resources extension="ABC:Core:Configure"
                                 property="-ABC.Core.Configure.Resource.Directory" />

        <tempfile property="abc:configure:extensions.file"
                  deleteonexit="true" />

        <tempfile property="abc:configure:profiles.file"
                  deleteonexit="true" />

        <echoproperties destfile="${abc:configure:profiles.file}"
                        prefix="profile."
                        format="xml" />

        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="false">
            <file file="${-ABC.Core.Configure.Resource.Directory}/Header.xml" />
        </concat>
        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="true"
                fixlastline="true">
            <file file="${abc:configure:profiles.file}" />
            <file file="${-ABC.Core.Configure.Resource.Directory}/Profile-Defaults.xml" />
            <fileset dir="${project.extensions.directory}"
                     includes="**/Extension.xml"
                     erroronmissingdir="false" />

            <fileset dir="${abc.extensions.directory}"
                     includes="**/Extension.xml" />

            <filterchain>
                <tokenfilter>
                    <filetokenizer />
                    <replaceregex pattern="&lt;\?xml\s[^?]+\?&gt;"
                                  replace=""
                                  flags="g" />
                </tokenfilter>
            </filterchain>
        </concat>
        <concat destfile="${abc:configure:extensions.file}"
                overwrite="true"
                append="true">
            <file file="${-ABC.Core.Configure.Resource.Directory}/Footer.xml" />
        </concat>

        <property name="-abc.configure.base.directory" location="${basedir}" />
        <property name="-abc.configure.build.file" location="${ant.file}" />

        <condition property="-abc.configure.default-target"
                   value="${ant.project.default-target}"
                   else="verify">
            <isset property="ant.project.default-target" />
        </condition>

        <xslt taskname="ABC:Core:Configure:Extension"
              in="${abc:configure:extensions.file}"
              out="${user.dir}/build.xml"
              style="${-ABC.Core.Configure.Resource.Directory}/Configure.xslt">

            <param name="project.default-target" expression="${-abc.configure.default-target}" />
            <param name="ant.project.name" expression="${ant.project.name}" />
            <param name="ant.basedir" expression="${-abc.configure.base.directory}" />
            <param name="ant.project.build-file" expression="${-abc.configure.build.file}" />
            <param name="user.dir" expression="${user.dir}" />

            <param name="abc.extensions.directory" expression="${abc.extensions.directory}" />
            <param name="project.extensions.directory" expression="${project.extensions.directory}" />
        </xslt>
    </target>

    <target name="configure" depends="-ABC:Core:Configure:Extension" />
</project>
