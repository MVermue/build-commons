<?xml version="1.0" encoding="UTF-8" ?>
<project name="ABC:Environment:PHP:PHPUnit:Extension"
         xmlns:ac="http://ant-contrib.sourceforge.net"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <abc:extension-init name="ABC:Environment:PHP:PHPUnit:Extension" />

    <target name="-ABC:Environment:PHP:PHPUnit:Extension"
            depends="-ABC:Environment:PHP:Php:Extension,
                     -ABC:Environment:PHP:Composer:Extension" />

    <!--
        Raw execution of phpunit with arbitrary arguments passed to it
    -->
    <abc:macrodef name="environment-phpunit-exec">
        <attribute name="dir" default="${abc.test.php.directory}"/>
        <element name="arguments" implicit="yes" />

        <sequential>
            <abc:environment-php dir="@{dir}"
                                 failonerror="true">
                <arg value="${abc.environment.php.phpunit.application.binary}" />
                <arguments />
            </abc:environment-php>
        </sequential>
    </abc:macrodef>

    <!--
        Encapsulated convenience call to phpunit executions

        This macro takes the following attributes:

        dir:
          The directory to run phpunit in. By default this is the php test dir

        configuration:
          Full path to the configuration file (phpunit.xml) to use for execution

          If the attribute is not specified, or set to an empty string. The phpunit
          default will be used (Search for a phpunit.xml.dist inside the working dir.
          If that one is not found search for a phpunit.xml in there.)

        testpath:
          Fullpath to the directory or testfile to execute as a starting point.

          By default this simply is the php test directory.

        Furthermore an optional element called <arguments> is supported, which
        may contain further <arg> elements to be passed to phpunit.
    -->
    <abc:macrodef name="environment-phpunit">
        <attribute name="dir" default="${abc.test.php.directory}"/>
        <attribute name="configuration" default="" />
        <attribute name="testpath" default="${abc.test.php.directory}" />
        <element name="arguments" optional="true" />

        <sequential>
            <ac:var name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                    unset="true" />
            <ac:if>
                <equals arg1="@{configuration}" arg2="" />
                <ac:then>
                    <property name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                              value="" />
                </ac:then>
                <ac:else>
                    <property name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                              value="--configuration '@{configuration}'" />
                </ac:else>
            </ac:if>

            <abc:environment-phpunit-exec>
                <arg line="${-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line}" />
                <arguments />
                <arg value="@{testpath}" />
            </abc:environment-phpunit-exec>
        </sequential>

    </abc:macrodef>
</project>
