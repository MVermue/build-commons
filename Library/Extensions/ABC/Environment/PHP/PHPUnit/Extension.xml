<?xml version="1.0" encoding="UTF-8" ?>
<project name="ABC:Environment:PHP:PHPUnit:Extension"
         xmlns:ac="http://ant-contrib.sourceforge.net"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <abc:extension-init name="ABC:Environment:PHP:PHPUnit:Extension" />

    <target name="-ABC:Environment:PHP:PHPUnit:Extension"
            depends="-ABC:Environment:PHP:Composer:Extension" />

    <!--
        Raw execution of phpunit with arbitrary arguments passed to it
    -->
    <abc:macrodef name="environment-phpunit-exec">
        <attribute name="dir" default="${abc.test.php.directory}"/>
        <element name="arguments" implicit="yes" />

        <sequential>
            <abc:exec executable="${abc.environment.executable.php}"
                      failonerror="true"
                      dir="@{dir}">
                <arg value="${abc.environment.php.phpunit.application.binary}" />

                <arguments />
            </abc:exec>
        </sequential>
    </abc:macrodef>

    <!--
        Encapsulated convenience call to phpunit executions

        This macro takes an optional configuration attribute, as well as two nested
        element sets:

        <arguments>:
          Optionally further commandline arguments to be supplied to phpunit

        <paths>:
          Arbitrary resourcesets, which contain a list of files/directories, to pass
          to phpunit for execution.

          The usual rules of phpunit executing given directories recursively does apply
          here of course
    -->
    <abc:macrodef name="environment-phpunit">
        <attribute name="dir" default="${abc.test.php.directory}"/>
        <attribute name="configuration" default="" />
        <element name="arguments" optional="true" />
        <element name="paths" />

        <sequential>
            <ac:var name="-ABC.Environment.PHP.PHPUnit.Execution.Paths"
                    unset="true" />
            <pathconvert property="-ABC.Environment.PHP.PHPUnit.Execution.Paths"
                         pathsep="' '"
                         setonempty="false">
                <paths />
            </pathconvert>

            <ac:var name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                    unset="true" />
            <ac:if>
                <equals arg1="@{configuration}" arg2="" />
                <ac:then>
                    <property name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                              value="" />
                </ac:then>
                <ac:else>
                    <property name="-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line"
                              value="--configuration '@{configuration}'" />
                </ac:else>
            </ac:if>

            <!-- Execute phpunit only, if there is at least something in the target
                 fileset -->
            <ac:if>
                <isset property="-ABC.Environment.PHP.PHPUnit.Execution.Paths" />
                <ac:then>
                    <abc:environment-phpunit-exec>
                        <arg line="${-ABC.Environment.PHP.PHPUnit.Execution.Configuration.Line}" />
                        <arguments />
                        <arg line="'${-ABC.Environment.PHP.PHPUnit.Execution.Paths}'" />
                    </abc:environment-phpunit-exec>
                </ac:then>
            </ac:if>
        </sequential>

    </abc:macrodef>
</project>
