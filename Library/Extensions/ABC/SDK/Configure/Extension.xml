<?xml version="1.0" encoding="UTF-8" ?>
<!--<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "../../../../../Experiments/ant.dtd">-->
<project name="ABC:SDK:Configure:Extension"
         xmlns:abc="http://abc.tools.qafoo.com/abc.xsd"
         xmlns:internal="http://abc.tools.qafoo.com/abc-internal.xsd">

    <target name="-ABC:SDK:Configure:Extension"
            depends="-ABC:SDK:Core:Extension"
			extensionOf="-configure:hamburger:with:fries~hook [">

        <abc:extension-init name="ABC:SDK:Configure:Extension"
                            has-resources="true" />

        <abc:tempfile property="-ABC.SDK.Configure.Enabled-Profiles.File"
                      suffix=".xml" />

        <echoproperties destfile="${-ABC.SDK.Configure.Enabled-Profiles.File}"
                        prefix="profile."
                        format="xml" />

        <internal:configure-generate-build-file
                srcfile="${-ABC.SDK.Configure.Enabled-Profiles.File}"
                destfile="${user.dir}/build.xml"
                filename="Extension.xml"
                mode="runtime" />

        <internal:configure-generate-build-file
                srcfile="${-ABC.SDK.Configure.Enabled-Profiles.File}"
                destfile="${user.dir}/configure.xml"
                filename="Configure.xml"
                mode="configure" />

        <ant antfile="${user.dir}/configure.xml"
             target="configure"
             inheritAll="false"
             inheritRefs="false" />
    </target>

    <internal:macrodef name="configure-generate-build-file">
        <attribute name="srcfile" />
        <attribute name="destfile" />
        <attribute name="mode" />
        <attribute name="filename" />

        <sequential>
            <tempfile property="-ABC.SDK.Configure.Generated.File"
                      suffix=".xml"
                      deleteonexit="true" />

            <internal:configure-generate-target-list
                    srcfile="@{srcfile}"
                    destfile="${-ABC.SDK.Configure.Generated.File}"
                    filename="@{filename}" />

            <property name="-ABC.SDK.Configure.Base.Directory" location="${basedir}" />
            <property name="-ABC.SDK.Configure.Build.File" location="${ant.file}" />

            <condition property="-ABC.SDK.Configure.Default-Target"
                       value="${ant.project.default-target}"
                       else="verify">
                <isset property="ant.project.default-target" />
            </condition>

            <xslt taskname="ABC:SDK:Configure:Extension"
                  in="${-ABC.SDK.Configure.Generated.File}"
                  out="@{destfile}"
                  style="${abc.sdk.configure.resources.directory}/Configure.xslt">

                <param name="project.default-target" expression="${-ABC.SDK.Configure.Default-Target}" />
                <param name="project.name" expression="${ant.project.name}" />
                <param name="project.directory" expression="${-ABC.SDK.Configure.Base.Directory}" />
                <param name="project.build.file" expression="${-ABC.SDK.Configure.Build.File}" />
                <param name="project.build.directory" expression="${user.dir}" />

                <param name="abc.extensions.directory" expression="${abc.extensions.directory}" />
                <param name="project.extensions.directory" expression="${project.extensions.directory}" />

                <param name="abc.mode" expression="@{mode}" />
            </xslt>
        </sequential>
    </internal:macrodef>

    <internal:macrodef name="configure-generate-target-list">
        <attribute name="srcfile" />
        <attribute name="destfile" />
        <attribute name="filename" />

        <sequential>
            <concat destfile="@{destfile}"
                    overwrite="true"
                    append="false">
                <file file="${abc.sdk.configure.resources.directory}/Header.xml" />
            </concat>
            <concat destfile="@{destfile}"
                    overwrite="true"
                    append="true"
                    fixlastline="true">

                <file file="@{srcfile}" />
                <file file="${abc.sdk.configure.resources.directory}/Profile-Defaults.xml" />

                <sort>
                    <fileset dir="${project.extensions.directory}"
                             includes="**/@{filename}"
                             erroronmissingdir="false" />
                    <name />
                </sort>
                <sort>
                    <fileset dir="${abc.extensions.directory}"
                             includes="**/@{filename},**/Common.xml" />
                    <name />
                </sort>

                <filterchain>
                    <tokenfilter>
                        <filetokenizer />
                        <replaceregex pattern="&lt;\?xml\s[^?]+\?&gt;"
                                      replace=""
                                      flags="g" />
                    </tokenfilter>
                </filterchain>
            </concat>
            <concat destfile="@{destfile}"
                    overwrite="true"
                    append="true">
                <file file="${abc.sdk.configure.resources.directory}/Footer.xml" />
            </concat>
        </sequential>
    </internal:macrodef>

    <target name="configure" 
            depends="-configure:hamburger:with:fries~hook [,
                     -configure:before~hook,
                     -configure:main~hook,
                     -configure:after~hook" />
</project>
